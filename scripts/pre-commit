#!/bin/bash

# Pre-commit hook for Go linting

set -e

# Check if golangci-lint is available
if ! command -v golangci-lint >/dev/null 2>&1; then
    echo "error: golangci-lint not installed"
    echo "  run: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
    exit 1
fi

# Get list of Go files being committed
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.go$')

if [ -z "$CHANGED_FILES" ]; then
    exit 0
fi

# Auto-fix formatting
echo "gofmt..."
FORMATTED_FILES=$(echo "$CHANGED_FILES" | xargs gofmt -l 2>/dev/null || true)
if [ -n "$FORMATTED_FILES" ]; then
    echo "$FORMATTED_FILES" | xargs gofmt -w
fi

# Auto-fix imports
echo "goimports..."
IMPORT_FILES=$(echo "$CHANGED_FILES" | xargs goimports -l 2>/dev/null || true)
if [ -n "$IMPORT_FILES" ]; then
    echo "$IMPORT_FILES" | xargs goimports -w
fi

# Run golangci-lint with auto-fixes
PACKAGES=$(echo "$CHANGED_FILES" | xargs dirname | sort | uniq)
if [ -n "$PACKAGES" ]; then
    for package in $PACKAGES; do
        golangci-lint run --fix "$package/..."
    done
fi

# Final validation
echo "lint check..."
if ! golangci-lint run $PACKAGES 2>/dev/null; then
    echo "error: linting failed (run 'make lint-fix' or 'make lint')"
    exit 1
fi

# Re-stage any auto-fixes made by the linter
FIXED_FILES=$(git diff --name-only | grep '\.go$' || true)
if [ -n "$FIXED_FILES" ]; then
    git add $FIXED_FILES
fi

exit 0